# racing-prediction-AI

競馬における勝ち馬予想を行うAIの作成と、AIによる予想を出力するプログラムです。

netkeiba様の提供する各レース情報をもとにAIの学習、勝ち馬の予想を行っております。

▼URLはこちら▼

https://race.netkeiba.com/top/?rf=navi

予想を出力させる際はrace_idを入力するだけなので、容易に使用できます。

# 開発理由
* ### 予想の効率化
競馬において予想をたてるとき、私たちは膨大な情報を整理しなければなりません。

各馬の近走データはもちろん、調教内容や当日のコンディション、各陣営の作戦やコメントにいたるまで、

ありとあらゆことが予想の材料となりえます。

これらを全てのレースに対して1人の人間が精査するのは不可能といえましょう。

そこでせめて、近走データの精査についてはAIに任せて予想の効率化を図ろう、

あわよくばAIで予想を当てようというのが開発理由の1つです。

* ### 競馬は単なる運だけで決まるものではない
競馬は公営競技として開催されており、ギャンブルであると同時にプロフェッショナルスポーツでもあります。

しかし、一般にはギャンブルという認識が強く、ギャンブルとしての勝敗だけでなくレースの勝敗までも運によって決まる

と思われる方が多くいらっしゃいます。

私はこの認識をAIによって変えられないかと考えました。AIの予想によって勝敗を当てることができれば、そこには勝つ理由やロジックが

あることの証明になると思い、開発を始めました。

# 機能紹介
* ### Learning.py
スクレイピング & 機械学習を行うファイルです。

機械学習モデルはlightgbmのlambdarank(Learning to Rank)を使用しています。

使用した説明変数のカテゴリーは40種(スピード指数、上がり3F、着差 etc...)、目的変数は1~3着に着順に応じたスコアをそれ以下の着順にはスコアなしでラベリングをしてあります。

モデルの精度テストとして単勝の回収率を閾値ごとに計算しています。

テスト方法は以下の2つ
* ##### 1着と予想したデータの予測値(出力値)が閾値を超えたレースのみ、馬券を購入したときの回収率

* ##### 1着と予想したデータの予測値と2着と予想したデータの予測値の差が閾値を超えたレースのみ、馬券を購入したときの回収率

閾値は0~2の間を0.1刻みで計20段階で変化し、閾値ごとの変化の様子をグラフとして計算後に出力します。

* ### Predict.py
学習済みモデルを用いて勝ち馬予想を行うファイルです。

以下使用手順になります。

* ##### 使用手順
①Predict.pyを実行すると入力待ち状態になります。
![function1](https://github.com/bunyu422/racing-prediction-AI/assets/154484676/de43220d-d2e8-4427-8663-752bff259584)

②レースIDを入力してEnterを押します。レースIDはnetkeiba様の各レースページのURLに記載されています。(下部に画像を掲載しております。)
![function2](https://github.com/bunyu422/racing-prediction-AI/assets/154484676/26be0b5a-577d-4423-a653-a1d6a7e0cf4c)

③予測結果が表示されます。2列目が馬番、4列目が予測スコアでスコアの高いものから表示されています。(オッズが表示されないのは仕様です。)
![function3](https://github.com/bunyu422/racing-prediction-AI/assets/154484676/788e3996-ec18-41eb-8418-8dc7e8122ad1)

※netkeiba様のレースページです。ハイライト部分がレースIDになります。
![2024-02-23 (2)](https://github.com/bunyu422/racing-prediction-AI/assets/154484676/7526c78e-201b-483d-a5f7-ac91dcdbc1e7)

* ### その他ディレクトリ
* csv... スクレイピングしたデータをcsv形式で保存しておくディレクトリです。
* pickle-dict... 特徴量のマッピングに使用する辞書がpickle形式で保存されています。(騎手、血統に関する辞書)
* pickle-tuner... 学習済みモデルがpickle形式で保存されています。

# 開発中に考えたこと
* Learning to Rankを選んだ理由

開発初期は2値、多クラス分類や回帰分析を中心に考えていましたが、それではデータ同士の関係性を考慮できないことに気づきました。

競馬は馬の能力が高ければ勝てるというものではなく、出走するレース内の他馬の出方やレース展開に勝敗が左右されます。

そこで、よりレースという枠組みにおける予測を表現できるLearning to Rank手法に切り替えました。

* 特徴量エンジニアリング

競馬では同じカテゴリーの特徴量でも、持つ意味が違うことが多々あります。例えば同じ走破タイムでも、走った距離やコースでそのタイムの価値は変わってきます。

特徴量として距離やコースもすべて使用することも可能ですが、それでは次元数が増えすぎて予測精度が落ちてしまいます。そこでタイムや距離、コースを考慮した

スピード指数という特徴量を作成することで次元の削減、データ間の価値のずれを抑えました。

* seed値による精度のばらつき

機械学習を行う際に再現性を確保するためにseed値を指定します。しかし、seed値によって精度にばらつきが生じます。

中には極端に精度の良いもの、悪いものがあり、1つのseed値だけではAIの精度を誤認する可能性があります。

そこで複数のseed値で学習を行い、それぞれのモデルが出力した予測値の平均をとることで、より正確な結果を得ることができます。

* stacking

上で述べたseed値によるばらつきにも関連しますが、seed値によって精度にばらつきが生じるなら

そのばらつきごとAIに学習させて精度を向上させようと思いました。

stackingは複数のモデルの予測値を説明変数として利用して、学習を行う手法です。

アルゴリズムの違うモデルを複数用いることが一般的なようですが、今回のような場合にも効果があると考え

実装しました。

# 使用技術
* Python 3.10.9

# 使用した主なライブラリ一覧
| Library           | Version                                              |
| ----------------- | --------------------------------------------------   |
| beautifulSoup     | 4.12.2                                               |
| lightgbm          | 4.0.0                                                |
| matplotlib        | 3.7.2                                                |
| numpy             | 1.25.2                                               |
| optuna            | 3.3.0                                                |
| pandas            | 1.4.2                                                |
| requests          | 2.31.0                                               |
| scikit-learn      | 1.3.0                                                |



